<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dart Manager Pro v63.2 - UI UNLOCK</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #05070a; --card: #11141d; --accent: #00ff95; --warn: #ffb800; --danger: #ff4757; --text: #ffffff; --border: #1e293b; --purple: #a855f7; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Sora', sans-serif; }
        .container { padding: 20px; max-width: 1600px; margin: 0 auto; position: relative; z-index: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: #0f172a; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; }
        .btn { border: none; padding: 10px 16px; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; transition: 0.2s; z-index: 10; }
        .match-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 6px; padding: 10px 15px; display: flex; align-items: center; gap: 12px; border-left: 8px solid transparent; }
        .role-pill { padding: 10px; border-radius: 6px; background: #000; text-align: center; font-weight: 700; border: 2px solid #1e293b; color: #fff; flex: 1; font-size: 0.85rem; }
        
        /* FIX: Modale nie mogą blokować przycisków jeśli są ukryte */
        .modal-view { position: fixed; inset: 0; background: var(--bg); z-index: 2000; padding: 40px; display: none; overflow-y: auto; }
        .active-view { display: block !important; }
        
        .tab { padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 800; border: 2px solid var(--border); text-transform: uppercase; font-size: 0.8rem; }
        .tv-row { background: var(--card); border-left: 15px solid transparent; padding: 25px; margin-bottom: 15px; display: flex; align-items: center; border-radius: 8px; }
        .tv-t-num { width: 140px; font-size: 4rem; font-weight: 900; }
        .tv-main { flex: 1; text-align: center; }
        .tv-names { font-size: 3.5rem; font-weight: 800; }
        .tv-timer { width: 250px; text-align: right; font-size: 3.5rem; color: var(--accent); font-family: monospace; }
        .tv-marker { color: var(--warn); font-size: 1.5rem; font-weight: 700; }
        .boards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .board-box { padding: 20px; background: #000; border-radius: 12px; border: 2px solid #222; }
        select, input { background: #000; color: #fff; border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-weight: 700; }
    </style>
</head>
<body>

<div id="admin-view" class="container active-view">
    <div class="header">
        <h2 style="margin:0; color:var(--accent)">DART MANAGER v63.2</h2>
        <div style="display:flex; gap:8px">
            <button onclick="openTimeline()" class="btn" style="background:var(--purple); color:#fff">OŚ CZASU</button>
            <button onclick="showAttendance()" class="btn" style="background:var(--danger); color:#fff">OBECNOŚĆ</button>
            <button onclick="showUI('tv-view')" class="btn" style="background:var(--accent); color:#000">TV</button>
            <button onclick="showUI('boards-view')" class="btn" style="background:#fff; color:#000">TARCZE</button>
            <button onclick="showUI('config-view')" class="btn" style="background:var(--warn); color:#000">OPCJE</button>
        </div>
    </div>
    <div id="tabs" style="display:flex; gap:10px; margin-bottom:20px; overflow-x: auto;"></div>
    <div id="matches"></div>
</div>

<div id="tv-view" class="modal-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
        <h1 style="color:var(--accent); margin:0">LIVE SCOREBOARD</h1>
        <button id="tv-back-btn" onclick="showUI('admin-view')" class="btn" style="background:#fff">POWRÓT</button>
    </div>
    <div id="tv-list"></div>
</div>

<div id="boards-view" class="modal-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
        <h1>STATUS TARCZ</h1>
        <button onclick="showUI('admin-view')" class="btn" style="background:#fff">POWRÓT</button>
    </div>
    <div id="boards-grid" class="boards-grid"></div>
</div>

<div id="config-view" class="modal-view">
    <div style="display:flex; justify-content:space-between; align-items:center"><h1>USTAWIENIA</h1><button onclick="showUI('admin-view')" class="btn" style="background:var(--accent); color:#000">ZAPISZ</button></div>
    <div style="max-width:600px; margin-top:20px; background:var(--card); padding:20px; border-radius:12px">
        <label>TARCZE:</label><input type="number" id="cfg-b" oninput="state.boards = parseInt(this.value)||1; sync();" style="width:100%; margin:10px 0">
        <div id="cfg-l"></div>
        <button onclick="addL()" class="btn" style="margin-top:15px; background:var(--purple); color:#fff; width:100%">+ DODAJ LIGĘ</button>
    </div>
</div>

<div id="attendance-view" class="modal-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px"><h1>OBECNOŚĆ</h1><button onclick="showUI('admin-view')" class="btn" style="background:var(--accent); color:#000">ZAPISZ</button></div>
    <div id="attendance-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px"></div>
</div>

<div id="timeline-view" class="modal-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px"><h1>OŚ CZASU</h1><button onclick="showUI('admin-view')" class="btn" style="background:var(--accent); color:#000">POWRÓT</button></div>
    <div id="timeline-container"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDd7dewomS7zjN7mzECobPwPxo8gOz8NfE",
        authDomain: "dartonline-3f908.firebaseapp.com",
        databaseURL: "https://dartonline-3f908.firebaseio.com",
        projectId: "dartonline-3f908",
        storageBucket: "dartonline-3f908.firebasestorage.app",
        messagingSenderId: "521598880668",
        appId: "1:521598880668:web:2b3da8df46a86b41db1659"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('dart_system_v63');

    let state = { leagues: [{ name: 'LIGA 1', color: '#00ff95', matches: [] }], idx: 0, boards: 16, absentPlayers: [] };
    let currentUI = 'admin-view';
    const isTVMode = window.location.search.includes('tv');

    function sync() { db.set(state); }

    db.on('value', (s) => { 
        if(s.val()) { 
            state = s.val(); 
            renderCurrent();
        } 
    });

    // Inicjalizacja trybu TV przy starcie
    window.onload = () => {
        if(isTVMode) {
            currentUI = 'tv-view';
            document.getElementById('tv-back-btn').style.display = 'none';
        }
        renderCurrent();
    };

    function showUI(id) {
        if(isTVMode) return; // Blokada dla linku ?tv
        currentUI = id;
        renderCurrent();
    }

    function renderCurrent() {
        // Ukryj wszystko
        document.getElementById('admin-view').classList.remove('active-view');
        document.querySelectorAll('.modal-view').forEach(m => m.classList.remove('active-view'));
        
        // Pokaż wybrane
        document.getElementById(currentUI).classList.add('active-view');

        // Renderowanie zależnie od widoku
        if(currentUI === 'admin-view') renderAdmin();
        if(currentUI === 'tv-view') renderTV();
        if(currentUI === 'boards-view') renderBoards();
        if(currentUI === 'config-view') renderConfig();
    }

    function renderAdmin() {
        const cur = state.leagues[state.idx] || state.leagues[0];
        document.getElementById('tabs').innerHTML = state.leagues.map((l, i) => `
            <div class="tab" style="border-color:${l.color}; background:${i===state.idx?l.color:'transparent'}; color:${i===state.idx?'#000':l.color}" onclick="state.idx=${i}; renderAdmin();">${l.name}</div>
        `).join('');

        let h = '';
        (cur.matches || []).forEach(m => {
            h += `<div class="match-card" style="border-left-color:${cur.color}">
                <div style="width:50px">T${m.b}</div>
                <div class="role-pill">${m.h}</div>
                <div class="role-pill">${m.g}</div>
                <div style="width:150px; text-align:right">
                    ${m.s==='plan'?`<button onclick="start('${m.id}')" class="btn" style="background:var(--accent)">START</button>`:''}
                    ${m.s==='live'?`<span style="color:var(--accent); font-weight:800; margin-right:10px">${m.e}</span><button onclick="stop('${m.id}')" class="btn" style="background:var(--danger)">STOP</button>`:''}
                </div>
            </div>`;
        });
        document.getElementById('matches').innerHTML = h || '<p>BRAK MECZÓW</p>';
    }

    function renderTV() {
        let live = []; 
        state.leagues.forEach(l => (l.matches||[]).forEach(m => { if(m.s==='live') live.push({...m, col: l.color}); }));
        live.sort((a,b) => a.b - b.b);
        document.getElementById('tv-list').innerHTML = live.map(m => `
            <div class="tv-row" style="border-left-color:${m.col}">
                <div class="tv-t-num" style="color:${m.col}">T${m.b}</div>
                <div class="tv-main">
                    <div class="tv-names">${m.h} VS ${m.g}</div>
                    <div class="tv-marker">LICZY: ${m.m || '---'}</div>
                </div>
                <div class="tv-timer">${m.e}</div>
            </div>`).join('') || '<h1 style="text-align:center; opacity:0.1; margin-top:100px">CZEKAMY...</h1>';
    }

    function renderBoards() {
        let h = '';
        for(let i=1; i<=state.boards; i++) {
            let m = null; 
            state.leagues.forEach(l => (l.matches||[]).forEach(x => { if(x.s==='live' && x.b==i) m={...x, col: l.color}; }));
            h += `<div class="board-box" style="border-color:${m?m.col:'#222'}">
                <div style="font-size:2rem; font-weight:900; color:${m?m.col:'#333'}">T${i}</div>
                <div style="font-weight:700; margin:10px 0">${m ? m.h+' VS '+m.g : 'WOLNA'}</div>
                <div style="color:var(--warn); font-weight:700; font-size:0.9rem">${m ? 'MARKER: '+(m.m||'--') : ''}</div>
                <div style="font-size:1.5rem; color:var(--accent); font-weight:800">${m ? m.e : ''}</div>
            </div>`;
        }
        document.getElementById('boards-grid').innerHTML = h;
    }

    function renderConfig() {
        document.getElementById('cfg-b').value = state.boards;
        document.getElementById('cfg-l').innerHTML = state.leagues.map((l, i) => `
            <div style="display:flex; gap:10px; margin-bottom:10px">
                <input type="text" value="${l.name}" oninput="state.leagues[${i}].name=this.value; sync();" style="flex:1">
                <input type="color" value="${l.color}" oninput="state.leagues[${i}].color=this.value; sync();">
            </div>
        `).join('');
    }

    function start(id) { state.leagues.forEach(l => (l.matches||[]).forEach(m => { if(m.id===id){ m.s='live'; m.start=Date.now(); } })); sync(); }
    function stop(id) { state.leagues.forEach(l => (l.matches||[]).forEach(m => { if(m.id===id) m.s='done'; })); sync(); }
    function addL() { state.leagues.push({ name: 'NOWA', color: '#ffffff', matches: [] }); sync(); }

    setInterval(() => {
        state.leagues.forEach(l => (l.matches||[]).forEach(m => {
            if(m.s === 'live' && m.start) {
                const d = Math.floor((Date.now() - m.start) / 1000);
                m.e = Math.floor(d/60).toString().padStart(2,'0')+':'+(d%60).toString().padStart(2,'0');
            }
        }));
        if(currentUI === 'admin-view' || currentUI === 'tv-view' || currentUI === 'boards-view') renderCurrent();
    }, 1000);
</script>
</body>
</html>
